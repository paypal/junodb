//
//  Copyright 2023 PayPal Inc.
//
//  Licensed to the Apache Software Foundation (ASF) under one or more
//  contributor license agreements.  See the NOTICE file distributed with
//  this work for additional information regarding copyright ownership.
//  The ASF licenses this file to You under the Apache License, Version 2.0
//  (the "License"); you may not use this file except in compliance with
//  the License.  You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//

package mayfly

import (
	"bytes"
	"testing"

	"juno/pkg/util"
)

func testRequestResponse(t *testing.T, rawRequest []byte, rawResponse []byte) {
	var request Msg

	if err := request.Decode(rawRequest); err != nil {
		t.Error(err)
	}
	raw, err := request.Encode()
	if err != nil {
		t.Error(err)
	}
	if bytes.Compare(rawRequest, raw) != 0 {
		util.HexDump(rawRequest)
		util.HexDump(raw)
		t.Error("not match")
	}
	var response Msg
	if err := response.Decode(rawResponse); err != nil {
		t.Error(err)
	}
	raw, err = response.Encode()
	if err != nil {
		t.Error(err)
	}
	if bytes.Compare(rawResponse, raw) != 0 {
		util.HexDump(rawResponse)
		util.HexDump(raw)
		t.Error("not match")
	}
}

func TestCreate(t *testing.T) {
	var (
		rawRequest = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x8d,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x55,
			0x00, 0x00, 0x00, 0x0d, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0x9d, 0x34, 0x27, 0x35,
			0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
			0xab, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x5f,
			0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0xdd, 0x00,
			0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x10, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00,
			0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x10,
			0x00, 0x00, 0x00, 0x07, 0x00, 0x04, 0x00, 0x00,
			0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79, 0x4e, 0x53,
			0x02, 0x61, 0x4b, 0x65, 0x79, 0x00, 0x02, 0x00,
			0x10, 0x7f, 0x00, 0x01, 0x01, 0x00, 0x01, 0x5f,
			0xd9, 0x59, 0x68, 0x5f, 0x37, 0x00, 0x01, 0x03,
			0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
			0x38, 0x39, 0x0a, 0x00, 0x00,
		}
		rawResponse = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x73,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x49,
			0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0x27, 0x35, 0x9d, 0x34,
			0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
			0xdd, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
			0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x59, 0x68, 0x5f, 0x37, 0x00, 0x00,
			0x0e, 0x10, 0x00, 0x01, 0x00, 0x07, 0x00, 0x04,
			0x00, 0x00, 0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79,
			0x4e, 0x53, 0x02, 0x61, 0x4b, 0x65, 0x79, 0x00,
			0x02, 0x00, 0x10, 0x7f, 0x00, 0x01, 0x01, 0x00,
			0x01, 0x5f, 0xd9, 0x59, 0x68, 0x5f, 0x37, 0x00,
			0x01, 0x00, 0x00,
		}
	)
	testRequestResponse(t, rawRequest, rawResponse)
}

func TestUpdate(t *testing.T) {
	var (
		rawRequest = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x8d,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x55,
			0x00, 0x00, 0x00, 0x0d, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0xd2, 0x5e, 0x27, 0x35,
			0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
			0xab, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x5f,
			0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0xdd, 0x00,
			0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x10, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00,
			0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x10,
			0x00, 0x00, 0x00, 0x07, 0x00, 0x04, 0x00, 0x00,
			0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79, 0x4e, 0x53,
			0x02, 0x61, 0x4b, 0x65, 0x79, 0x00, 0x02, 0x00,
			0x10, 0x7f, 0x00, 0x01, 0x01, 0x00, 0x00, 0x31,
			0x93, 0x59, 0x6c, 0x41, 0x68, 0x00, 0x01, 0x03,
			0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
			0x38, 0x39, 0x0a, 0x00, 0x00,
		}
		rawResponse = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x73,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x49,
			0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0x27, 0x35, 0xd2, 0x5e,
			0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
			0xdd, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
			0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x59, 0x6c, 0x41, 0x58, 0x00, 0x00,
			0x0e, 0x10, 0x00, 0x02, 0x00, 0x07, 0x00, 0x04,
			0x00, 0x00, 0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79,
			0x4e, 0x53, 0x02, 0x61, 0x4b, 0x65, 0x79, 0x00,
			0x02, 0x00, 0x10, 0x7f, 0x00, 0x01, 0x01, 0x00,
			0x00, 0x31, 0x93, 0x59, 0x6c, 0x41, 0x68, 0x00,
			0x01, 0x00, 0x00,
		}
	)
	testRequestResponse(t, rawRequest, rawResponse)
}

func TestGet(t *testing.T) {
	var (
		rawRequest = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x81,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x49,
			0x00, 0x00, 0x00, 0x0d, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0xd2, 0x60, 0x27, 0x35,
			0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
			0xab, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x5f,
			0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0xdd, 0x00,
			0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x10, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x10,
			0x00, 0x00, 0x00, 0x07, 0x00, 0x04, 0x00, 0x00,
			0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79, 0x4e, 0x53,
			0x02, 0x61, 0x4b, 0x65, 0x79, 0x00, 0x02, 0x00,
			0x10, 0x7f, 0x00, 0x01, 0x01, 0x00, 0x00, 0x33,
			0x36, 0x59, 0x6c, 0x41, 0xf7, 0x00, 0x01, 0x00,
			0x00,
		}
		rawResponse = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x7f,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x55,
			0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0x27, 0x35, 0xd2, 0x60,
			0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
			0xdd, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
			0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x0b, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x59, 0x6c, 0x41, 0x58, 0x00, 0x00,
			0x0e, 0x10, 0x00, 0x02, 0x00, 0x07, 0x00, 0x04,
			0x00, 0x00, 0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79,
			0x4e, 0x53, 0x02, 0x61, 0x4b, 0x65, 0x79, 0x00,
			0x02, 0x00, 0x10, 0x7f, 0x00, 0x01, 0x01, 0x00,
			0x00, 0x33, 0x36, 0x59, 0x6c, 0x41, 0xf7, 0x00,
			0x01, 0x03, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
			0x36, 0x37, 0x38, 0x39, 0x0a, 0x00, 0x00,
		}
	)
	testRequestResponse(t, rawRequest, rawResponse)
}

func TestDestroy(t *testing.T) {
	var (
		rawRequest = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x81,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x49,
			0x00, 0x00, 0x00, 0x0d, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0xd2, 0x62, 0x27, 0x35,
			0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
			0xab, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x5f,
			0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0xdd, 0x00,
			0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x10, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x07, 0x00, 0x04, 0x00, 0x00,
			0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79, 0x4e, 0x53,
			0x02, 0x61, 0x4b, 0x65, 0x79, 0x00, 0x02, 0x00,
			0x10, 0x7f, 0x00, 0x01, 0x01, 0x00, 0x00, 0x33,
			0x86, 0x59, 0x6c, 0x42, 0x39, 0x00, 0x01, 0x00,
			0x00,
		}
		rawResponse = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x73,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x49,
			0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0x27, 0x35, 0xd2, 0x62,
			0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
			0xdd, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
			0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x59, 0x6c, 0x41, 0x58, 0x00, 0x00,
			0x0d, 0xce, 0x00, 0x02, 0x00, 0x07, 0x00, 0x04,
			0x00, 0x00, 0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79,
			0x4e, 0x53, 0x02, 0x61, 0x4b, 0x65, 0x79, 0x00,
			0x02, 0x00, 0x10, 0x7f, 0x00, 0x01, 0x01, 0x00,
			0x00, 0x33, 0x86, 0x59, 0x6c, 0x42, 0x39, 0x00,
			0x01, 0x00, 0x00,
		}
	)
	testRequestResponse(t, rawRequest, rawResponse)
}

func TestSet(t *testing.T) {
	var (
		rawRequest = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x8d,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x55,
			0x00, 0x00, 0x00, 0x0d, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0xd2, 0x64, 0x27, 0x35,
			0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
			0xab, 0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x5f,
			0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0xdd, 0x00,
			0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x10, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00,
			0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x10,
			0x00, 0x00, 0x00, 0x07, 0x00, 0x04, 0x00, 0x00,
			0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79, 0x4e, 0x53,
			0x02, 0x61, 0x4b, 0x65, 0x79, 0x00, 0x02, 0x00,
			0x10, 0x7f, 0x00, 0x01, 0x01, 0x00, 0x00, 0x33,
			0xff, 0x59, 0x6c, 0x42, 0x86, 0x00, 0x01, 0x03,
			0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
			0x38, 0x39, 0x0a, 0x00, 0x00,
		}
		rawResponse = []byte{
			0xde, 0xef, 0xca, 0xfe, 0x00, 0x00, 0x00, 0x73,
			0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x49,
			0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x01,
			0x7f, 0x00, 0x00, 0x01, 0x27, 0x35, 0xd2, 0x64,
			0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
			0xdd, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
			0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x59, 0x6c, 0x42, 0x86, 0x00, 0x00,
			0x0e, 0x10, 0x00, 0x01, 0x00, 0x07, 0x00, 0x04,
			0x00, 0x00, 0x01, 0x44, 0x75, 0x6d, 0x6d, 0x79,
			0x4e, 0x53, 0x02, 0x61, 0x4b, 0x65, 0x79, 0x00,
			0x02, 0x00, 0x10, 0x7f, 0x00, 0x01, 0x01, 0x00,
			0x00, 0x33, 0xff, 0x59, 0x6c, 0x42, 0x86, 0x00,
			0x01, 0x00, 0x00,
		}
	)
	testRequestResponse(t, rawRequest, rawResponse)
}
