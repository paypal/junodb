<!--

Copyright 2023 PayPal Inc.

Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to You under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Package utility provides the utility interfaces for mux package

-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="ISO-8859-1">
    <title></title>
    <link rel="icon" href="juno.png" type="image/png" sizes="16x16">

    <!--<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
    <link rel="stylesheet" href="fonts/material-design-icons/font.css">

    <!--<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
        crossorigin="anonymous">-->
    <link rel="stylesheet" href="fonts/fontawesome/css/all.min.css">

    <!--<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>-->
    <script type="text/javascript" src="js-css/jquery-3.3.1.min.js"></script>


    <script lang="javascript" src="js-css/underscore-min.js"></script>
    <script type="text/javascript" src="js-css/common.js"></script>
    <script type="text/javascript" src="js-css/svg.js"></script>
    <script type="text/javascript" src="js-css/redist-view.js"></script>
    <script type="text/javascript" src="js-css/mapping-view.js"></script>
    <script type="text/javascript" src="js-css/shardmap.js"></script>

    <!--<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">-->
    <link rel="stylesheet" type="text/css" href="js-css/bootstrap-3.3.7/css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" href="js-css/style.css">
    <link rel="stylesheet" type="text/css" href="js-css/shards-style.css">

    <!--<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">-->
    <link rel="stylesheet" href="js-css/jquery-ui-1.12.1/jquery-ui.css">

    <script type="text/javascript">
        $(document).ready(function () {
            $.ajaxSetup({ cache: false });

            var locationURL = new URL(window.location.href);
            var file = getURLParam(locationURL, "file");
            var refresh = getURLParam(locationURL, "refresh") != 'false';
            //var replay = getURLParam(locationURL, "replay");
            //var clusterDataURL = (file != null ? (replay != null ? `redistHistory/${replay}/` : "testdata/") + file : "etcd_state.json");
            var clusterDataURL = (file != null ? "testdata/" + file : "etcd_state.json");

            const SHARDMAP_SYNC_DELAY = 500;
            //const REPLAY_SYNC_DELAY = 1000;

            var shardMapSyncTimeout;
            var shardMap = null;
            var renders = {
                "redist": redistRender,
                "mapping": mappingRender,
            };
            var viewState = "mapping";
            var expandedZones = null;

            function syncZones(state) {
                // Initially expand all zones
                if (expandedZones == null && shardMap == null && state != null) {
                    expandedZones = new Set(state.mapping.zones.map(x => x.id));
                }

                // If redist has just finished, update redistStateLog
                if (state.state == "mapping" && (shardMap != null && shardMap.state == "redist")) {
                    shardMap = null; // Otherwise we end up in an endless loop...
                    refreshRedistStateLog(state, true, syncZones, syncZones);
                    return;
                }

                if (!_.isEqual(shardMap, state)) {
                    doRender(state);
                }

                /*
                if (replay) {
                    if (replayIsPlaying()) {
                        if (shardMap.state != 'redist') {
                            replayPlayPause();
                        } else {
                            shardMapSyncTimeout = setTimeout(_ => replayIncrementState(1), REPLAY_SYNC_DELAY);
                        }
                    }
                } else if (refresh) {
                    shardMapSyncTimeout = setTimeout(_ => getShardMap(clusterDataURL, true, syncZones, syncFailure), SHARDMAP_SYNC_DELAY);
                }
                */
                if (refresh) {
                    shardMapSyncTimeout = setTimeout(_ => getShardMap(clusterDataURL, true, syncZones, syncFailure), SHARDMAP_SYNC_DELAY);
                }
            }


            function syncFailure(jqXHR, error) {
                /*if (replay) {
                    if (replayIsPlaying()) {
                        replayPlayPause();
                    }
                    replayIncrementState(-1);
                } else {
                    console.error(error);
                    console.error(jqXHR);
                }*/

                console.error(error);
                console.error(jqXHR);

                /*
                if (refresh) {
                    shardMapSyncTimeout = setTimeout(_ => getShardMap(clusterDataURL, true, syncZones, syncFailure), SHARDMAP_SYNC_DELAY);
                }
                */
            }

            /*
            function replayIsPlaying() {
                return !$('#replay-play').is(':visible');
            }


            function replayPlayPause() {
                if (!replayIsPlaying()) {
                    $('#replay-play').hide();
                    $('#replay-pause').show();
                    replayIncrementState(1);
                } else {
                    $('#replay-pause').hide();
                    $('#replay-play').show();
                    clearTimeout(shardMapSyncTimeout);
                }
            }


            function replayIncrementState(increment) {
                var locationURL = new URL(window.location.href);
                var file = getURLParam(locationURL, "file");
                var stateVersion = parseInt(file.substr(0, file.indexOf(".json")));

                if (!isNaN(stateVersion)) {
                    if (stateVersion + increment < 0) {
                        return;
                    }
                    var nextFile = `${stateVersion + increment}.json`;
                    getShardMap(`redistHistory/${replay}/${nextFile}`, true, syncZones, syncFailure);
                    var url = new URL(locationURL);
                    url.searchParams.set('file', nextFile);
                    history.replaceState({}, window.title, url);
                } else {
                    console.error(`Failed to parse state version from ${file}`);
                }
            }
            */

            function toggleZoneVisibility(zone) {
                var expanded = zone.hasClass('expanded');
                if (expanded) {
                    zone.removeClass('expanded').addClass('collapsed');
                    zone.children('.content').hide();
                    expandedZones.delete(divIDToZoneID(zone[0].id));
                } else {
                    zone.removeClass('collapsed').addClass('expanded');
                    zone.children('.content').show();
                    expandedZones.add(divIDToZoneID(zone[0].id));
                }
                if (viewState == "redist") {
                    drawConnections(shardMap);
                }
            }

            function doRender(state) {
                var expandAllZones = false;

                if (state != null) {
                    if (state.state == "redist" && (shardMap != null && shardMap.state == "mapping")) {
                        viewState = "redist";
                        expandAllZones = true;
                    } else if (state.state == "redist" && (shardMap == null || shardMap.state == "mapping")) {
                        viewState = "redist";
                    }
                    shardMap = state;
                }

                if (shardMap == null || _.isEmpty(shardMap)) {
                    return;
                }

                if (shardMap.redist == null) {
                    $('#shard-buttons #redist').hide();
                    if (viewState == "redist") {
                        return;
                    }
                } else {
                    $('#shard-buttons #redist').show();
                }

                var render = renders[viewState];

                $(document).attr("title", render.title);
                $("#navbar-brand-title").text(render.title);
                $('#juno-tooltip').hide();

                render.updateData(shardMap, resetZones, expandedZones, expandAllZones);
                if (render.getProgress != null) {
                    var progress = render.getProgress(shardMap);
                    setTotalProgress(progress);
                } else {
                    hideTotalProgress();
                }

                var zones = $('.zones').find('.zone');
                if (zones.length > 0) {
                    expandedZones = new Set($.map($('.zones').find('.zone.expanded'), x => divIDToZoneID(x.id)));
                }
            }


            function resetZones() {
                $('.zones').removeClass().addClass('zones').children().remove();
            }

            function setTotalProgress(progress) {
                $('#totalProgress .progress-bar').css('width', `${Math.round(progress * 100)}%`);
                $('#totalProgress').show(); 
            }

            function hideTotalProgress() {
                $('#totalProgress').hide();
            }

            $(document).on('click', '.expander', function () { toggleZoneVisibility($(this).parent()) });
            $(window).resize(function () {
                if (viewState == "redist") {
                    drawConnections(shardMap)
                }
            });

            function showError(msg, level) {
                var elem = $('#error');
                elem.attr('class', '');
                if (level != null) {
                    elem.attr('class', level);
                }
                $('#error').html(msg);
                $('#error').show();
            }


            function clearError(msg) {
                $('#error').html("");
                $('#error').hide();
            }

            $('#darkmodetoggle .switch input').change(darkmodeToggleChanged);
            updateDarkmode();
            window.addEventListener('storage', function (e) { // Local storage value changed (darkmode toggled in another tab or window)
                updateDarkmode();
            });


            // Store the change in the user's browser, then update the page
            function darkmodeToggleChanged() {
                var checked = $('#darkmodetoggle .switch input').is(":checked");
                if (checked) {
                    localStorage.setItem("darkmode", "on");
                } else {
                    localStorage.setItem("darkmode", "off");
                }
                updateDarkmode();
            }


            // Update the page
            function updateDarkmode() {
                if (localStorage.getItem("darkmode") == "on") {
                    $('#darkmodetoggle .switch input').prop('checked', true);
                    $("body").addClass('darkmode');
                } else {
                    $('#darkmodetoggle .switch input').prop('checked', false);
                    $("body").removeClass('darkmode');
                }
                doRender();
            }


            function hideModal() {
                $('#modal').hide();
                modalFuncs.refresh = null;
            }


            $('#shard-buttons').on('click', 'span.button', function () {
                var btn = $(this);
                viewState = btn.parent()[0].id;
                if (shardMap != null) {
                    var render = renders[viewState];
                    if (render.buttonHandler != null) {
                        render.buttonHandler(btn, doRender);
                    }
                }
            });

            /*
            $('#replay-play').on('click', replayPlayPause);
            $('#replay-pause').on('click', replayPlayPause);
            $('#replay-prev').on('click', _ => replayIncrementState(-1));
            $('#replay-next').on('click', _ => replayIncrementState(1));
            */

            window.onclick = function (event) {
                if ($(event.target).hasClass("juno-modal-close") || $(event.target).hasClass("juno-modal")) {
                    hideModal();
                }
            };

            /*
            if (replay) {
                $('#replay-controls').show();
            }
            */

            shardMapSyncTimeout = setTimeout(_ => getShardMap(clusterDataURL, false, syncZones, syncFailure), 0);
        });
    </script>

</head>

<body>
    <svg id="svg-canvas">
        <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto">
                <path d="M 5 10 L 0 0 L 10 0 z" />
            </marker>
        </defs>
    </svg>

    <div id="modal" class="juno-modal">
        <div class="juno-modal-content">
            <span class="juno-modal-close">&times;</span>
        </div>
    </div>

    <div id="juno-tooltip">
        <span id="juno-tooltiptext"></span>
    </div>

    <div id="controlsWrapper">
        <span id="navbar-brand-title">Shard Redistribution</span>
        <div id="totalProgress" class="progress" style="margin: 0 30px;display:inline-block;height:100%;margin:0 15px 0 -5px;display: flex;flex: 1;justify-content: stretch; display:none;">
            <div class="progress-bar" style="height:16px"></div>
        </div>
        <div id="controls">
            <!--<div class="replay-controls" id="replay-controls">
                <i id="replay-prev" class="material-icons">fast_rewind</i>
                <i id="replay-play" class="material-icons">play_arrow</i>
                <i id="replay-pause" style="display:none" class="material-icons">pause</i>
                <i id="replay-next" class="material-icons">fast_forward</i>
            </div>-->
            <div class="dropdown" id="menu">
                <div class="dropdownbtn"></div>
                <div class="dropdown-content">
                    <a href="/shutdown">Shutdown Server</a>
                </div>
            </div>
            <div id="darkmodetoggle">
                <label class="switch">
                    <input type="checkbox" id="darkmodetoggleinput">
                    <span class="slider round"></span>
                    <i class="slider-icon fas fa-moon"></i>
                </label>
            </div>
            <div style="padding-left:10px;cursor:pointer">
                <i class="material-icons" id="help-btn">help_outline</i>
                <!--<i class="far fa-question-circle fa-lg" id="help-btn"></i>-->
            </div>
        </div>
    </div>

    <div id="error"></div>

    <div id="shard-buttons">
        <div id="mapping">
            <span class="shard-buttons-label">Shard Mapping:</span>
            <span class="button">By Zone</span>
            <span class="button">By Shard</span>
        </div>
        &nbsp;
        <div id="redist">
            <span class="shard-buttons-label">Redistribution:</span>
            <span class="button">Grid View</span>
            <span class="button">Graph View</span>
            <span class="button">List View</span>
        </div>
    </div>

    <div class="container-fluid">
        <div class="zones"></div>
    </div>

</body>

</html>